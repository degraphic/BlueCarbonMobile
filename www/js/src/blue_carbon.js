// Generated by CoffeeScript 1.4.0
(function() {
  var _base, _base1, _base2, _base3,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  window.onerror = function(message, url, linenumber) {
    console.log("JavaScript error: " + message + " on line " + linenumber + " for " + url);
    return alert("JavaScript error: " + message + " on line " + linenumber + " for " + url);
  };

  $.support.cors = true;

  window.Wcmc || (window.Wcmc = {});

  window.BlueCarbon || (window.BlueCarbon = {});

  window.BlueCarbon.bus = _.extend({}, Backbone.Events);

  (_base = window.BlueCarbon).Models || (_base.Models = {});

  (_base1 = window.BlueCarbon).Controllers || (_base1.Controllers = {});

  (_base2 = window.BlueCarbon).Views || (_base2.Views = {});

  (_base3 = window.BlueCarbon).Routers || (_base3.Routers = {});

  BlueCarbon.App = (function() {

    _.extend(App.prototype, Backbone.Events);

    function App(options) {
      this.buildMap = __bind(this.buildMap, this);

      this.downloadBaseLayer = __bind(this.downloadBaseLayer, this);

      this.start = __bind(this.start, this);

      var waitForRemoteConsole,
        _this = this;
      waitForRemoteConsole = options.waitForRemoteConsole;
      this.localFileName = "bluecarbon.mbtiles";
      this.remoteFile = "https://dl.dropbox.com/u/2324263/bluecarbon.mbtiles";
      this.on('mapReady', function() {
        return _this.controller = new BlueCarbon.Controller({
          app: _this
        });
      });
      BlueCarbon.bus.on('user:gotAuthToken', function(token) {
        console.log("logged in, using token " + token);
        return $.ajaxSetup({
          data: {
            auth_token: token
          }
        });
      });
      this.ready = false;
      if (waitForRemoteConsole) {
        document.addEventListener("deviceready", (function() {
          return _this.ready = true;
        }), false);
      } else {
        document.addEventListener("deviceready", (function() {
          _this.ready = true;
          return _this.start();
        }), false);
      }
    }

    App.prototype.start = function() {
      if (!this.ready) {
        alert('not ready yet!');
        return false;
      }
      this.map = new L.Map("map", {
        center: new L.LatLng(24.2870, 54.3274),
        zoom: 10
      });
      return this.addBaseLayer();
    };

    App.prototype.addBaseLayer = function() {
      var _this = this;
      window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
        var file;
        window.fs = fileSystem;
        return file = fs.root.getFile(_this.localFileName, {
          create: false
        }, _this.buildMap, _this.downloadBaseLayer);
      });
      return window.BlueCarbon.SQLiteDb = window.sqlitePlugin.openDatabase("BlueCarbon.db", "1.0", "Test", 10000000);
    };

    App.prototype.downloadBaseLayer = function() {
      var ft;
      console.log("Downloading file...");
      ft = new FileTransfer();
      return ft.download(this.remoteFile, fs.root.fullPath + "/" + this.localFileName, this.buildMap, function(error) {
        alert("Download failed, check error log");
        return console.log(error);
      });
    };

    App.prototype.buildMap = function() {
      var db, tileLayer;
      db = window.sqlitePlugin.openDatabase(this.localFileName, "1.0", "Tiles", 2000000);
      tileLayer = new L.TileLayer.MBTiles(db, {
        tms: true
      }).addTo(this.map);
      return this.trigger('mapReady');
    };

    return App;

  })();

  BlueCarbon.Controller = (function(_super) {

    __extends(Controller, _super);

    function Controller(options) {
      this.addValidation = __bind(this.addValidation, this);

      this.areaEdit = __bind(this.areaEdit, this);

      this.loginUser = __bind(this.loginUser, this);
      this.app = options.app;
      this.sidePanel = new Backbone.ViewManager('#side-panel');
      this.modal = new Backbone.ViewManager('#modal-container');
      this.loginUser();
    }

    Controller.prototype.loginUser = function() {
      var loginView;
      loginView = new BlueCarbon.Views.LoginView();
      $('#modal-disabler').addClass('active');
      this.modal.showView(loginView);
      return this.transitionToActionOn(loginView, 'user:loggedIn', this.areaEdit);
    };

    Controller.prototype.areaEdit = function() {
      var areaEditView;
      areaEditView = new BlueCarbon.Views.AreaEditView();
      this.sidePanel.showView(areaEditView);
      return this.transitionToActionOn(areaEditView, 'addPolygon', this.addValidation);
    };

    Controller.prototype.addValidation = function(options) {
      var validationView;
      validationView = new BlueCarbon.Views.AddValidationView({
        map: this.app.map
      });
      this.sidePanel.showView(validationView);
      return this.transitionToActionOn(validationView, 'polygon:created', this.areaEdit);
    };

    return Controller;

  })(Wcmc.Controller);

}).call(this);
